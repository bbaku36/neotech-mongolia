name: Facebook Auto Post

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: facebook-autopost
  cancel-in-progress: false

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: FACEBOOK_PAGE_ACCESS_TOKEN

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate required secrets
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_ACCESS_TOKEN: ${{ secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}
        run: |
          missing=0
          if [ -z "$FACEBOOK_PAGE_ID" ]; then
            echo "::error::Missing secret: FACEBOOK_PAGE_ID"
            missing=1
          fi
          if [ -z "$FACEBOOK_PAGE_ACCESS_TOKEN" ]; then
            echo "::error::Missing secret: FACEBOOK_PAGE_ACCESS_TOKEN"
            missing=1
          fi
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Restore posting state cache
        uses: actions/cache/restore@v4
        with:
          path: .state/posted_items.json
          key: fb-state-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            fb-state-

      - name: Ensure state directory
        run: mkdir -p .state

      - name: Run autopost
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_ACCESS_TOKEN: ${{ secrets.FACEBOOK_PAGE_ACCESS_TOKEN }}
          AI_PROVIDER: "gemini"
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: "gemini-2.5-flash"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HTTP_RETRIES: "4"
          HTTP_RETRY_BACKOFF_SEC: "3"
          DRY_RUN: "0"
          PYTHONUNBUFFERED: "1"
        run: python scripts/generate_and_post.py

      - name: Ensure state file exists
        if: always()
        run: |
          mkdir -p .state
          if [ ! -f .state/posted_items.json ]; then
            echo "{}" > .state/posted_items.json
          fi

      - name: Save posting state cache
        if: always()
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: .state/posted_items.json
          key: fb-state-${{ github.run_id }}-${{ github.run_attempt }}
